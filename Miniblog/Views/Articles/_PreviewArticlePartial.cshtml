@using Miniblog.Models.Entities
@using Miniblog.Models.Services.Interfaces

@inject IOptionRepository<ListDisplayOptions> listDisplayRepo

@model Article

@{ 
    ListDisplayOptions listOptions = await listDisplayRepo.FirstOrDefaultAsync();
    ArticleOptions articleOptions = Model.DisplayOptions;
    if (listOptions.OverrideForUserArticle)
    {
        listOptions = (ListDisplayOptions)articleOptions;
    }
}

<article class="art text-alegreya-style">
    <div class="blog-content">

        <div class="article-meta text-roboto-style">
            <a href="@Url.Action("Article", "Articles", new { title = Model.Link })" class="article-header">
                <h2><b>@Model.Header</b></h2>
            </a>
            <ul class="article-info clearfix">
                @if (listOptions.Username)
                {
                    <li class="article-info-user">
                        <a href="@Url.Action("Account", "Users", new { username = Model.User.Username })">
                            <div class="user-info-container">
                                @if (Model.User.Avatar != null)
                                {
                                    <img src="data:image/jpeg;base64,@(Convert.ToBase64String(Model.User.Avatar))" width="10px" height="10px" alt="@Model.User.Username">
                                }
                                else
                                {
                                    <img src="@Url.Content("~/img/social_line/anonymous_user.png")" width="10px" height="10px" alt="User">
                                }
                                <span>@Model.User.Username</span>
                            </div>
                        </a>
                    </li>

                    @*<li><a href="@Url.Action("User", "Users", new { username = Model.User.Username })">@Model.User.Username</a></li>*@
                }
                @if (listOptions.DateAndTime)
                {
                    <li class="article-datetime"><a href="#">@Model.DateTime.Day @Model.DateTime.Month @Model.DateTime.Hour @Model.DateTime.Minute</a></li>
                }
                
                @if (listOptions.Likes)
                {
                    <li>
                        <img src="/img/buttons/heart.png" alt="likes" height="20px" width="20px">
                        <span name="articleLikesInfo">@Model.Likes.Count</span>
                    </li>
                }
                @if (listOptions.Bookmarks)
                {
                    <li>
                        <img src="/img/ico/bookmark5.png" alt="bookmarks" height="20px" width="20px">
                        <span name="articleBookmarksInfo">@Model.Bookmarks.Count</span>
                    </li>
                }
                @if (listOptions.Comments)
                {
                    <li>
                        <img src="/img/buttons/chat-2.png" alt="comments" height="18px" width="18px">
                        <span name="articleCommentsInfo">@Model.Comments.Count</span>
                    </li>
                }
                @if (listOptions.Topic)
                {
                    <li><span>Topic: </span><a href="#">@(Model.Topic?.Name ?? "no topic")</a></li>
                }
                @if (listOptions.Series)
                {
                    <li><span>Series: </span><a href="#">@(Model.Series?.Name ?? "no series")</a></li>
                }
                @if (listOptions.Tags)
                {
                    <li>
                        Tags:
                        @{
                            string[] tags = Model.Tags.Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
                            int counter = tags.Length <= 5 ? tags.Length : 5;
                            for (int i = 0; i < counter; i++)
                            {
                                if (i != counter - 1)
                                {
                                    <a href="#">@tags[i],</a>
                                }
                                else
                                {
                                    <a href="#">@tags[i]</a>
                                }
                            }
                            if(counter == 0)
                            {
                                <span>no tags</span>
                            }
                        }
                    </li>
                }
            </ul>
        </div>

        @{
            if (Model.Images.Any())
            {
                <div class="article-image">
                    <img src="data:image/@Model.Images[0].FileExtension;base64,@(Convert.ToBase64String(Model.Images[0].File))" alt="preview image">
                </div>
            }
        }

        <div class="blog-text">
            @{
                string[] words = Model.Text.Split(new string[] { " ", Environment.NewLine }, StringSplitOptions.RemoveEmptyEntries);
                int count = words.Length < 30 ? words.Length : 30;
                string previewText = string.Join(" ", words, 0, count);
                <p>@previewText</p>
            }
            <div class="read-action">
                <a href="@Url.Action("Article", "Articles", new { title = Model.Link })">Read more &RightArrow;</a>
            </div>
        </div>
    </div>
</article>