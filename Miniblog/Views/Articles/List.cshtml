@using Microsoft.Extensions.Options
@using Domain.Entities.Enums
@using Web.Configuration
@using Repo.Interfaces;
@using System.Security.Claims;

@model ListViewModel
@inject IOptionRepository<Role> rolesRepo

@{
    Role role = null;
    if (User.Identity.IsAuthenticated)
    {
        string roleType = User.FindFirstValue(ClaimsIdentity.DefaultRoleClaimType);
        RoleType rt = (RoleType)Enum.Parse(typeof(RoleType), roleType);
        role = rolesRepo.Find(r => r.Type == rt).FirstOrDefault();
    }
}

@if (Model.Articles.Any())
{
    await Html.RenderPartialAsync("~/Views/Articles/_ListParametersPartial.cshtml", Model);
}

<div id="articlesContainer" class="blog-container">

    @{
        if (!Model.Articles.Any())
        {
            ServerMessage serverMessage = new ServerMessage()
            {
                ShowSmile = true,
                MessageText = "No articles yet"
            };
            await Html.RenderPartialAsync("_ServerMessagePartial", serverMessage);
        }
        else
        {
            foreach (var article in Model.Articles)
            {
                await Html.RenderPartialAsync("~/Views/Articles/_PreviewArticlePartial.cshtml", article);
            }
        }
    }

</div>

@if (Model.Articles.Any())
{
    string previous = Url.Action(Model.PageName.ToLower(), "articles", new
    {
        page = Model.CurrentPageNumber - 1,
        sortby = Enum.GetName(typeof(ListSorting), Model.ListSortingType).ToLower()
    });
    string next = Url.Action(Model.PageName.ToLower(), "articles", new
    {
        page = Model.CurrentPageNumber + 1,
        sortby = Enum.GetName(typeof(ListSorting), Model.ListSortingType).ToLower()
    });

    @*<div class="load-more-container">
            <button type="button" class="usual-button usual-button-reverse" id="loadMoreButton">Load more</button>
        </div>*@

    @if (Model.CurrentPageNumber > 1 && Model.CurrentPageNumber < Model.TotalPages)
    {
        <div class="load-more-container blog">
            <a href="@previous" class="button-left usual-button usual-button-reverse" id="previousPageButton">Previous</a>
            <a href="@next" class="button-right usual-button" id="nextPageButton">Next</a>
        </div>
    }
    else if (Model.CurrentPageNumber <= 1 && Model.CurrentPageNumber != Model.TotalPages)
    {
        <div class="load-more-container one-button-container">
            <a href="@next" class="button-right usual-button" id="nextPageButton">Next</a>
        </div>
    }
    else if (Model.CurrentPageNumber > 1 && Model.CurrentPageNumber != Model.TotalPages)
    {
        <div class="load-more-container one-button-container">
            <a href="@previous" class="button-left usual-button usual-button-reverse" id="previousPageButton">Previous</a>
        </div>
    }

    @section Scripts {
        @await Html.PartialAsync("_ListScripts")
    }
}
else if (Model.PageName.Equals("List") && User.Identity.IsAuthenticated && (role?.WriteArticles ?? default))
{
    <div class="load-more-container">
        <a asp-action="Add" asp-controller="Articles" class="usual-button usual-button-reverse">Add new</a>
    </div>
}